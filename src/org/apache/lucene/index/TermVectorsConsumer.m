//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: ./core/src/java/org/apache/lucene/index/TermVectorsConsumer.java
//

#include "IOSClass.h"
#include "IOSObjectArray.h"
#include "J2ObjC_source.h"
#include "java/io/Closeable.h"
#include "java/io/IOException.h"
#include "java/lang/System.h"
#include "java/util/Arrays.h"
#include "java/util/Map.h"
#include "org/apache/lucene/codecs/Codec.h"
#include "org/apache/lucene/codecs/TermVectorsFormat.h"
#include "org/apache/lucene/codecs/TermVectorsWriter.h"
#include "org/apache/lucene/index/ByteSliceReader.h"
#include "org/apache/lucene/index/DocumentsWriterPerThread.h"
#include "org/apache/lucene/index/FieldInfo.h"
#include "org/apache/lucene/index/FieldInfos.h"
#include "org/apache/lucene/index/FieldInvertState.h"
#include "org/apache/lucene/index/SegmentInfo.h"
#include "org/apache/lucene/index/SegmentWriteState.h"
#include "org/apache/lucene/index/TermVectorsConsumer.h"
#include "org/apache/lucene/index/TermVectorsConsumerPerField.h"
#include "org/apache/lucene/index/TermsHash.h"
#include "org/apache/lucene/index/TermsHashPerField.h"
#include "org/apache/lucene/store/FlushInfo.h"
#include "org/apache/lucene/store/IOContext.h"
#include "org/apache/lucene/store/TrackingDirectoryWrapper.h"
#include "org/apache/lucene/util/ArrayUtil.h"
#include "org/apache/lucene/util/BytesRef.h"
#include "org/apache/lucene/util/IOUtils.h"
#include "org/apache/lucene/util/RamUsageEstimator.h"

@interface OrgApacheLuceneIndexTermVectorsConsumer () {
 @public
  IOSObjectArray *perFields_;
}

- (void)initTermVectorsWriter OBJC_METHOD_FAMILY_NONE;

@end

J2OBJC_FIELD_SETTER(OrgApacheLuceneIndexTermVectorsConsumer, perFields_, IOSObjectArray *)

__attribute__((unused)) static void OrgApacheLuceneIndexTermVectorsConsumer_initTermVectorsWriter(OrgApacheLuceneIndexTermVectorsConsumer *self);

@implementation OrgApacheLuceneIndexTermVectorsConsumer

- (instancetype)initWithOrgApacheLuceneIndexDocumentsWriterPerThread:(OrgApacheLuceneIndexDocumentsWriterPerThread *)docWriter {
  OrgApacheLuceneIndexTermVectorsConsumer_initWithOrgApacheLuceneIndexDocumentsWriterPerThread_(self, docWriter);
  return self;
}

- (void)flushWithJavaUtilMap:(id<JavaUtilMap>)fieldsToFlush
withOrgApacheLuceneIndexSegmentWriteState:(OrgApacheLuceneIndexSegmentWriteState *)state {
  if (writer_ != nil) {
    jint numDocs = [((OrgApacheLuceneIndexSegmentInfo *) nil_chk(((OrgApacheLuceneIndexSegmentWriteState *) nil_chk(state))->segmentInfo_)) maxDoc];
    JreAssert((numDocs > 0), (@"org/apache/lucene/index/TermVectorsConsumer.java:60 condition failed: assert numDocs > 0;"));
    @try {
      [self fillWithInt:numDocs];
      JreAssert((state->segmentInfo_ != nil), (@"org/apache/lucene/index/TermVectorsConsumer.java:64 condition failed: assert state.segmentInfo != null;"));
      [((OrgApacheLuceneCodecsTermVectorsWriter *) nil_chk(writer_)) finishWithOrgApacheLuceneIndexFieldInfos:state->fieldInfos_ withInt:numDocs];
    }
    @finally {
      OrgApacheLuceneUtilIOUtils_closeWithJavaIoCloseableArray_([IOSObjectArray arrayWithObjects:(id[]){ writer_ } count:1 type:JavaIoCloseable_class_()]);
      JreStrongAssign(&writer_, nil);
      lastDocID_ = 0;
      hasVectors_ = false;
    }
  }
}

- (void)fillWithInt:(jint)docID {
  while (lastDocID_ < docID) {
    [((OrgApacheLuceneCodecsTermVectorsWriter *) nil_chk(writer_)) startDocumentWithInt:0];
    [((OrgApacheLuceneCodecsTermVectorsWriter *) nil_chk(writer_)) finishDocument];
    lastDocID_++;
  }
}

- (void)initTermVectorsWriter {
  OrgApacheLuceneIndexTermVectorsConsumer_initTermVectorsWriter(self);
}

- (void)finishDocument {
  if (!hasVectors_) {
    return;
  }
  OrgApacheLuceneUtilArrayUtil_introSortWithJavaLangComparableArray_withInt_withInt_(perFields_, 0, numVectorFields_);
  OrgApacheLuceneIndexTermVectorsConsumer_initTermVectorsWriter(self);
  [self fillWithInt:((OrgApacheLuceneIndexDocumentsWriterPerThread_DocState *) nil_chk(docState_))->docID_];
  [((OrgApacheLuceneCodecsTermVectorsWriter *) nil_chk(writer_)) startDocumentWithInt:numVectorFields_];
  for (jint i = 0; i < numVectorFields_; i++) {
    [((OrgApacheLuceneIndexTermVectorsConsumerPerField *) nil_chk(IOSObjectArray_Get(nil_chk(perFields_), i))) finishDocument];
  }
  [((OrgApacheLuceneCodecsTermVectorsWriter *) nil_chk(writer_)) finishDocument];
  JreAssert((lastDocID_ == docState_->docID_), (JreStrcat("$I$I", @"lastDocID=", lastDocID_, @" docState.docID=", docState_->docID_)));
  lastDocID_++;
  [super reset];
  [self resetFields];
}

- (void)abort {
  hasVectors_ = false;
  @try {
    [super abort];
  }
  @finally {
    if (writer_ != nil) {
      OrgApacheLuceneUtilIOUtils_closeWhileHandlingExceptionWithJavaIoCloseableArray_([IOSObjectArray arrayWithObjects:(id[]){ writer_ } count:1 type:JavaIoCloseable_class_()]);
      JreStrongAssign(&writer_, nil);
    }
    lastDocID_ = 0;
    [self reset];
  }
}

- (void)resetFields {
  JavaUtilArrays_fillWithNSObjectArray_withId_(perFields_, nil);
  numVectorFields_ = 0;
}

- (OrgApacheLuceneIndexTermsHashPerField *)addFieldWithOrgApacheLuceneIndexFieldInvertState:(OrgApacheLuceneIndexFieldInvertState *)invertState
                                                          withOrgApacheLuceneIndexFieldInfo:(OrgApacheLuceneIndexFieldInfo *)fieldInfo {
  return create_OrgApacheLuceneIndexTermVectorsConsumerPerField_initWithOrgApacheLuceneIndexFieldInvertState_withOrgApacheLuceneIndexTermVectorsConsumer_withOrgApacheLuceneIndexFieldInfo_(invertState, self, fieldInfo);
}

- (void)addFieldToFlushWithOrgApacheLuceneIndexTermVectorsConsumerPerField:(OrgApacheLuceneIndexTermVectorsConsumerPerField *)fieldToFlush {
  if (numVectorFields_ == ((IOSObjectArray *) nil_chk(perFields_))->size_) {
    jint newSize = OrgApacheLuceneUtilArrayUtil_oversizeWithInt_withInt_(numVectorFields_ + 1, JreLoadStatic(OrgApacheLuceneUtilRamUsageEstimator, NUM_BYTES_OBJECT_REF));
    IOSObjectArray *newArray = [IOSObjectArray arrayWithLength:newSize type:OrgApacheLuceneIndexTermVectorsConsumerPerField_class_()];
    JavaLangSystem_arraycopyWithId_withInt_withId_withInt_withInt_(perFields_, 0, newArray, 0, numVectorFields_);
    JreStrongAssign(&perFields_, newArray);
  }
  IOSObjectArray_Set(perFields_, numVectorFields_++, fieldToFlush);
}

- (void)startDocument {
  [self resetFields];
  numVectorFields_ = 0;
}

- (void)dealloc {
  RELEASE_(writer_);
  RELEASE_(flushTerm_);
  RELEASE_(docWriter_);
  RELEASE_(vectorSliceReaderPos_);
  RELEASE_(vectorSliceReaderOff_);
  RELEASE_(perFields_);
  [super dealloc];
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "initWithOrgApacheLuceneIndexDocumentsWriterPerThread:", "TermVectorsConsumer", NULL, 0x1, NULL, NULL },
    { "flushWithJavaUtilMap:withOrgApacheLuceneIndexSegmentWriteState:", "flush", "V", 0x0, "Ljava.io.IOException;", "(Ljava/util/Map<Ljava/lang/String;Lorg/apache/lucene/index/TermsHashPerField;>;Lorg/apache/lucene/index/SegmentWriteState;)V" },
    { "fillWithInt:", "fill", "V", 0x0, "Ljava.io.IOException;", NULL },
    { "initTermVectorsWriter", NULL, "V", 0x2, "Ljava.io.IOException;", NULL },
    { "finishDocument", NULL, "V", 0x0, "Ljava.io.IOException;", NULL },
    { "abort", NULL, "V", 0x1, NULL, NULL },
    { "resetFields", NULL, "V", 0x0, NULL, NULL },
    { "addFieldWithOrgApacheLuceneIndexFieldInvertState:withOrgApacheLuceneIndexFieldInfo:", "addField", "Lorg.apache.lucene.index.TermsHashPerField;", 0x1, NULL, NULL },
    { "addFieldToFlushWithOrgApacheLuceneIndexTermVectorsConsumerPerField:", "addFieldToFlush", "V", 0x0, NULL, NULL },
    { "startDocument", NULL, "V", 0x0, NULL, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "writer_", NULL, 0x0, "Lorg.apache.lucene.codecs.TermVectorsWriter;", NULL, NULL, .constantValue.asLong = 0 },
    { "flushTerm_", NULL, 0x10, "Lorg.apache.lucene.util.BytesRef;", NULL, NULL, .constantValue.asLong = 0 },
    { "docWriter_", NULL, 0x10, "Lorg.apache.lucene.index.DocumentsWriterPerThread;", NULL, NULL, .constantValue.asLong = 0 },
    { "vectorSliceReaderPos_", NULL, 0x10, "Lorg.apache.lucene.index.ByteSliceReader;", NULL, NULL, .constantValue.asLong = 0 },
    { "vectorSliceReaderOff_", NULL, 0x10, "Lorg.apache.lucene.index.ByteSliceReader;", NULL, NULL, .constantValue.asLong = 0 },
    { "hasVectors_", NULL, 0x0, "Z", NULL, NULL, .constantValue.asLong = 0 },
    { "numVectorFields_", NULL, 0x0, "I", NULL, NULL, .constantValue.asLong = 0 },
    { "lastDocID_", NULL, 0x0, "I", NULL, NULL, .constantValue.asLong = 0 },
    { "perFields_", NULL, 0x2, "[Lorg.apache.lucene.index.TermVectorsConsumerPerField;", NULL, NULL, .constantValue.asLong = 0 },
  };
  static const J2ObjcClassInfo _OrgApacheLuceneIndexTermVectorsConsumer = { 2, "TermVectorsConsumer", "org.apache.lucene.index", NULL, 0x10, 10, methods, 9, fields, 0, NULL, 0, NULL, NULL, NULL };
  return &_OrgApacheLuceneIndexTermVectorsConsumer;
}

@end

void OrgApacheLuceneIndexTermVectorsConsumer_initWithOrgApacheLuceneIndexDocumentsWriterPerThread_(OrgApacheLuceneIndexTermVectorsConsumer *self, OrgApacheLuceneIndexDocumentsWriterPerThread *docWriter) {
  OrgApacheLuceneIndexTermsHash_initWithOrgApacheLuceneIndexDocumentsWriterPerThread_withBoolean_withOrgApacheLuceneIndexTermsHash_(self, docWriter, false, nil);
  JreStrongAssignAndConsume(&self->flushTerm_, new_OrgApacheLuceneUtilBytesRef_init());
  JreStrongAssignAndConsume(&self->vectorSliceReaderPos_, new_OrgApacheLuceneIndexByteSliceReader_init());
  JreStrongAssignAndConsume(&self->vectorSliceReaderOff_, new_OrgApacheLuceneIndexByteSliceReader_init());
  JreStrongAssignAndConsume(&self->perFields_, [IOSObjectArray newArrayWithLength:1 type:OrgApacheLuceneIndexTermVectorsConsumerPerField_class_()]);
  JreStrongAssign(&self->docWriter_, docWriter);
}

OrgApacheLuceneIndexTermVectorsConsumer *new_OrgApacheLuceneIndexTermVectorsConsumer_initWithOrgApacheLuceneIndexDocumentsWriterPerThread_(OrgApacheLuceneIndexDocumentsWriterPerThread *docWriter) {
  J2OBJC_NEW_IMPL(OrgApacheLuceneIndexTermVectorsConsumer, initWithOrgApacheLuceneIndexDocumentsWriterPerThread_, docWriter)
}

OrgApacheLuceneIndexTermVectorsConsumer *create_OrgApacheLuceneIndexTermVectorsConsumer_initWithOrgApacheLuceneIndexDocumentsWriterPerThread_(OrgApacheLuceneIndexDocumentsWriterPerThread *docWriter) {
  J2OBJC_CREATE_IMPL(OrgApacheLuceneIndexTermVectorsConsumer, initWithOrgApacheLuceneIndexDocumentsWriterPerThread_, docWriter)
}

void OrgApacheLuceneIndexTermVectorsConsumer_initTermVectorsWriter(OrgApacheLuceneIndexTermVectorsConsumer *self) {
  if (self->writer_ == nil) {
    OrgApacheLuceneStoreIOContext *context = create_OrgApacheLuceneStoreIOContext_initWithOrgApacheLuceneStoreFlushInfo_(create_OrgApacheLuceneStoreFlushInfo_initWithInt_withLong_([((OrgApacheLuceneIndexDocumentsWriterPerThread *) nil_chk(self->docWriter_)) getNumDocsInRAM], [self->docWriter_ bytesUsed]));
    JreStrongAssign(&self->writer_, [((OrgApacheLuceneCodecsTermVectorsFormat *) nil_chk([((OrgApacheLuceneCodecsCodec *) nil_chk(self->docWriter_->codec_)) termVectorsFormat])) vectorsWriterWithOrgApacheLuceneStoreDirectory:self->docWriter_->directory_ withOrgApacheLuceneIndexSegmentInfo:[self->docWriter_ getSegmentInfo] withOrgApacheLuceneStoreIOContext:context]);
    self->lastDocID_ = 0;
  }
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(OrgApacheLuceneIndexTermVectorsConsumer)
