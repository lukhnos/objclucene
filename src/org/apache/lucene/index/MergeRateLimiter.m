//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: ./core/src/java/org/apache/lucene/index/MergeRateLimiter.java
//

#include "IOSObjectArray.h"
#include "J2ObjC_source.h"
#include "java/lang/Double.h"
#include "java/lang/Enum.h"
#include "java/lang/IllegalArgumentException.h"
#include "java/lang/InterruptedException.h"
#include "java/lang/Math.h"
#include "java/lang/System.h"
#include "org/apache/lucene/index/MergePolicy.h"
#include "org/apache/lucene/index/MergeRateLimiter.h"
#include "org/apache/lucene/store/RateLimiter.h"
#include "org/apache/lucene/util/ThreadInterruptedException.h"

@class OrgApacheLuceneIndexMergeRateLimiter_PauseResult;

#if __has_feature(objc_arc)
#error "org/apache/lucene/index/MergeRateLimiter must not be compiled with ARC (-fobjc-arc)"
#endif

@interface OrgApacheLuceneIndexMergeRateLimiter () {
 @public
  jlong lastNS_;
  jlong minPauseCheckBytes_;
  jboolean abort_;
}

/*!
 @brief Returns NO if no pause happened, STOPPED if pause because rate was 0.0 (merge is stopped), PAUSED if paused with a normal rate limit.
 */
- (OrgApacheLuceneIndexMergeRateLimiter_PauseResult *)maybePauseWithLong:(jlong)bytes
                                                                withLong:(jlong)curNS;

@end

inline jint OrgApacheLuceneIndexMergeRateLimiter_get_MIN_PAUSE_CHECK_MSEC(void);
#define OrgApacheLuceneIndexMergeRateLimiter_MIN_PAUSE_CHECK_MSEC 25
J2OBJC_STATIC_FIELD_CONSTANT(OrgApacheLuceneIndexMergeRateLimiter, MIN_PAUSE_CHECK_MSEC, jint)

__attribute__((unused)) static OrgApacheLuceneIndexMergeRateLimiter_PauseResult *OrgApacheLuceneIndexMergeRateLimiter_maybePauseWithLong_withLong_(OrgApacheLuceneIndexMergeRateLimiter *self, jlong bytes, jlong curNS);

typedef NS_ENUM(NSUInteger, OrgApacheLuceneIndexMergeRateLimiter_PauseResult_Enum) {
  OrgApacheLuceneIndexMergeRateLimiter_PauseResult_Enum_NO = 0,
  OrgApacheLuceneIndexMergeRateLimiter_PauseResult_Enum_STOPPED = 1,
  OrgApacheLuceneIndexMergeRateLimiter_PauseResult_Enum_PAUSED = 2,
};

/*!
 @brief Returned by <code>maybePause</code>.
 */
@interface OrgApacheLuceneIndexMergeRateLimiter_PauseResult : JavaLangEnum

@property (readonly, class, nonnull) OrgApacheLuceneIndexMergeRateLimiter_PauseResult *NO_ NS_SWIFT_NAME(NO_);
@property (readonly, class, nonnull) OrgApacheLuceneIndexMergeRateLimiter_PauseResult *STOPPED NS_SWIFT_NAME(STOPPED);
@property (readonly, class, nonnull) OrgApacheLuceneIndexMergeRateLimiter_PauseResult *PAUSED NS_SWIFT_NAME(PAUSED);
+ (IOSObjectArray *)values;

+ (OrgApacheLuceneIndexMergeRateLimiter_PauseResult *)valueOfWithNSString:(NSString *)name;

- (OrgApacheLuceneIndexMergeRateLimiter_PauseResult_Enum)toNSEnum;

@end

J2OBJC_STATIC_INIT(OrgApacheLuceneIndexMergeRateLimiter_PauseResult)

/*! INTERNAL ONLY - Use enum accessors declared below. */
FOUNDATION_EXPORT OrgApacheLuceneIndexMergeRateLimiter_PauseResult *OrgApacheLuceneIndexMergeRateLimiter_PauseResult_values_[];

inline OrgApacheLuceneIndexMergeRateLimiter_PauseResult *OrgApacheLuceneIndexMergeRateLimiter_PauseResult_get_NO(void);
J2OBJC_ENUM_CONSTANT(OrgApacheLuceneIndexMergeRateLimiter_PauseResult, NO)

inline OrgApacheLuceneIndexMergeRateLimiter_PauseResult *OrgApacheLuceneIndexMergeRateLimiter_PauseResult_get_STOPPED(void);
J2OBJC_ENUM_CONSTANT(OrgApacheLuceneIndexMergeRateLimiter_PauseResult, STOPPED)

inline OrgApacheLuceneIndexMergeRateLimiter_PauseResult *OrgApacheLuceneIndexMergeRateLimiter_PauseResult_get_PAUSED(void);
J2OBJC_ENUM_CONSTANT(OrgApacheLuceneIndexMergeRateLimiter_PauseResult, PAUSED)

__attribute__((unused)) static void OrgApacheLuceneIndexMergeRateLimiter_PauseResult_initWithNSString_withInt_(OrgApacheLuceneIndexMergeRateLimiter_PauseResult *self, NSString *__name, jint __ordinal);

__attribute__((unused)) static IOSObjectArray *OrgApacheLuceneIndexMergeRateLimiter_PauseResult_values(void);

__attribute__((unused)) static OrgApacheLuceneIndexMergeRateLimiter_PauseResult *OrgApacheLuceneIndexMergeRateLimiter_PauseResult_valueOfWithNSString_(NSString *name);

FOUNDATION_EXPORT OrgApacheLuceneIndexMergeRateLimiter_PauseResult *OrgApacheLuceneIndexMergeRateLimiter_PauseResult_fromOrdinal(NSUInteger ordinal);

J2OBJC_TYPE_LITERAL_HEADER(OrgApacheLuceneIndexMergeRateLimiter_PauseResult)

@implementation OrgApacheLuceneIndexMergeRateLimiter

- (instancetype)initWithOrgApacheLuceneIndexMergePolicy_OneMerge:(OrgApacheLuceneIndexMergePolicy_OneMerge *)merge {
  OrgApacheLuceneIndexMergeRateLimiter_initWithOrgApacheLuceneIndexMergePolicy_OneMerge_(self, merge);
  return self;
}

- (void)setMBPerSecWithDouble:(jdouble)mbPerSec {
  @synchronized(self) {
    if (mbPerSec < 0.0) {
      @throw create_JavaLangIllegalArgumentException_initWithNSString_(JreStrcat("$D", @"mbPerSec must be positive; got: ", mbPerSec));
    }
    self->mbPerSec_ = mbPerSec;
    minPauseCheckBytes_ = JavaLangMath_minWithLong_withLong_(1024 * 1024, JreFpToLong(((OrgApacheLuceneIndexMergeRateLimiter_MIN_PAUSE_CHECK_MSEC / 1000.0) * mbPerSec * 1024 * 1024)));
    JreAssert(minPauseCheckBytes_ >= 0, @"org/apache/lucene/index/MergeRateLimiter.java:67 condition failed: assert minPauseCheckBytes >= 0;");
    [self java_notify];
  }
}

- (jdouble)getMBPerSec {
  @synchronized(self) {
    return mbPerSec_;
  }
}

- (jlong)getTotalBytesWritten {
  return JreLoadVolatileLong(&totalBytesWritten_);
}

- (jlong)pauseWithLong:(jlong)bytes {
  JrePlusAssignVolatileLongJ(&totalBytesWritten_, bytes);
  jlong startNS = JavaLangSystem_nanoTime();
  jlong curNS = startNS;
  jlong pausedNS = 0;
  while (true) {
    OrgApacheLuceneIndexMergeRateLimiter_PauseResult *result = OrgApacheLuceneIndexMergeRateLimiter_maybePauseWithLong_withLong_(self, bytes, curNS);
    if (result == JreLoadEnum(OrgApacheLuceneIndexMergeRateLimiter_PauseResult, NO)) {
      lastNS_ = curNS;
      break;
    }
    curNS = JavaLangSystem_nanoTime();
    jlong ns = curNS - startNS;
    startNS = curNS;
    if (result == JreLoadEnum(OrgApacheLuceneIndexMergeRateLimiter_PauseResult, STOPPED)) {
      totalStoppedNS_ += ns;
    }
    else {
      JreAssert(result == JreLoadEnum(OrgApacheLuceneIndexMergeRateLimiter_PauseResult, PAUSED), @"org/apache/lucene/index/MergeRateLimiter.java:109 condition failed: assert result == PauseResult.PAUSED;");
      totalPausedNS_ += ns;
    }
    pausedNS += ns;
  }
  return pausedNS;
}

- (jlong)getTotalStoppedNS {
  @synchronized(self) {
    return totalStoppedNS_;
  }
}

- (jlong)getTotalPausedNS {
  @synchronized(self) {
    return totalPausedNS_;
  }
}

- (OrgApacheLuceneIndexMergeRateLimiter_PauseResult *)maybePauseWithLong:(jlong)bytes
                                                                withLong:(jlong)curNS {
  return OrgApacheLuceneIndexMergeRateLimiter_maybePauseWithLong_withLong_(self, bytes, curNS);
}

- (void)checkAbort {
  @synchronized(self) {
    if (abort_) {
      @throw create_OrgApacheLuceneIndexMergePolicy_MergeAbortedException_initWithNSString_(JreStrcat("$$", @"merge is aborted: ", [((OrgApacheLuceneIndexMergePolicy_OneMerge *) nil_chk(merge_)) segString]));
    }
  }
}

- (void)setAbort {
  @synchronized(self) {
    abort_ = true;
    [self java_notify];
  }
}

- (jboolean)getAbort {
  @synchronized(self) {
    return abort_;
  }
}

- (jlong)getMinPauseCheckBytes {
  return minPauseCheckBytes_;
}

- (void)dealloc {
  RELEASE_(merge_);
  [super dealloc];
}

+ (const J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { NULL, NULL, 0x1, -1, 0, -1, -1, -1, -1 },
    { NULL, "V", 0x21, 1, 2, -1, -1, -1, -1 },
    { NULL, "D", 0x21, -1, -1, -1, -1, -1, -1 },
    { NULL, "J", 0x1, -1, -1, -1, -1, -1, -1 },
    { NULL, "J", 0x1, 3, 4, 5, -1, -1, -1 },
    { NULL, "J", 0x21, -1, -1, -1, -1, -1, -1 },
    { NULL, "J", 0x21, -1, -1, -1, -1, -1, -1 },
    { NULL, "LOrgApacheLuceneIndexMergeRateLimiter_PauseResult;", 0x22, 6, 7, 5, -1, -1, -1 },
    { NULL, "V", 0x21, -1, -1, 5, -1, -1, -1 },
    { NULL, "V", 0x21, -1, -1, -1, -1, -1, -1 },
    { NULL, "Z", 0x21, -1, -1, -1, -1, -1, -1 },
    { NULL, "J", 0x1, -1, -1, -1, -1, -1, -1 },
  };
  #pragma clang diagnostic push
  #pragma clang diagnostic ignored "-Wobjc-multiple-method-names"
  #pragma clang diagnostic ignored "-Wundeclared-selector"
  methods[0].selector = @selector(initWithOrgApacheLuceneIndexMergePolicy_OneMerge:);
  methods[1].selector = @selector(setMBPerSecWithDouble:);
  methods[2].selector = @selector(getMBPerSec);
  methods[3].selector = @selector(getTotalBytesWritten);
  methods[4].selector = @selector(pauseWithLong:);
  methods[5].selector = @selector(getTotalStoppedNS);
  methods[6].selector = @selector(getTotalPausedNS);
  methods[7].selector = @selector(maybePauseWithLong:withLong:);
  methods[8].selector = @selector(checkAbort);
  methods[9].selector = @selector(setAbort);
  methods[10].selector = @selector(getAbort);
  methods[11].selector = @selector(getMinPauseCheckBytes);
  #pragma clang diagnostic pop
  static const J2ObjcFieldInfo fields[] = {
    { "MIN_PAUSE_CHECK_MSEC", "I", .constantValue.asInt = OrgApacheLuceneIndexMergeRateLimiter_MIN_PAUSE_CHECK_MSEC, 0x1a, -1, -1, -1, -1 },
    { "totalBytesWritten_", "J", .constantValue.asLong = 0, 0x40, -1, -1, -1, -1 },
    { "mbPerSec_", "D", .constantValue.asLong = 0, 0x0, -1, -1, -1, -1 },
    { "lastNS_", "J", .constantValue.asLong = 0, 0x2, -1, -1, -1, -1 },
    { "minPauseCheckBytes_", "J", .constantValue.asLong = 0, 0x2, -1, -1, -1, -1 },
    { "abort_", "Z", .constantValue.asLong = 0, 0x2, -1, -1, -1, -1 },
    { "totalPausedNS_", "J", .constantValue.asLong = 0, 0x0, -1, -1, -1, -1 },
    { "totalStoppedNS_", "J", .constantValue.asLong = 0, 0x0, -1, -1, -1, -1 },
    { "merge_", "LOrgApacheLuceneIndexMergePolicy_OneMerge;", .constantValue.asLong = 0, 0x10, -1, -1, -1, -1 },
  };
  static const void *ptrTable[] = { "LOrgApacheLuceneIndexMergePolicy_OneMerge;", "setMBPerSec", "D", "pause", "J", "LOrgApacheLuceneIndexMergePolicy_MergeAbortedException;", "maybePause", "JJ", "LOrgApacheLuceneIndexMergeRateLimiter_PauseResult;" };
  static const J2ObjcClassInfo _OrgApacheLuceneIndexMergeRateLimiter = { "MergeRateLimiter", "org.apache.lucene.index", ptrTable, methods, fields, 7, 0x1, 12, 9, -1, 8, -1, -1, -1 };
  return &_OrgApacheLuceneIndexMergeRateLimiter;
}

@end

void OrgApacheLuceneIndexMergeRateLimiter_initWithOrgApacheLuceneIndexMergePolicy_OneMerge_(OrgApacheLuceneIndexMergeRateLimiter *self, OrgApacheLuceneIndexMergePolicy_OneMerge *merge) {
  OrgApacheLuceneStoreRateLimiter_init(self);
  JreStrongAssign(&self->merge_, merge);
  [self setMBPerSecWithDouble:JavaLangDouble_POSITIVE_INFINITY];
}

OrgApacheLuceneIndexMergeRateLimiter *new_OrgApacheLuceneIndexMergeRateLimiter_initWithOrgApacheLuceneIndexMergePolicy_OneMerge_(OrgApacheLuceneIndexMergePolicy_OneMerge *merge) {
  J2OBJC_NEW_IMPL(OrgApacheLuceneIndexMergeRateLimiter, initWithOrgApacheLuceneIndexMergePolicy_OneMerge_, merge)
}

OrgApacheLuceneIndexMergeRateLimiter *create_OrgApacheLuceneIndexMergeRateLimiter_initWithOrgApacheLuceneIndexMergePolicy_OneMerge_(OrgApacheLuceneIndexMergePolicy_OneMerge *merge) {
  J2OBJC_CREATE_IMPL(OrgApacheLuceneIndexMergeRateLimiter, initWithOrgApacheLuceneIndexMergePolicy_OneMerge_, merge)
}

OrgApacheLuceneIndexMergeRateLimiter_PauseResult *OrgApacheLuceneIndexMergeRateLimiter_maybePauseWithLong_withLong_(OrgApacheLuceneIndexMergeRateLimiter *self, jlong bytes, jlong curNS) {
  @synchronized(self) {
    [self checkAbort];
    jdouble secondsToPause = (bytes / 1024. / 1024.) / self->mbPerSec_;
    jlong targetNS = self->lastNS_ + JreFpToLong((1000000000 * secondsToPause));
    jlong curPauseNS = targetNS - curNS;
    if (curPauseNS <= 2000000) {
      return JreRetainedLocalValue(JreLoadEnum(OrgApacheLuceneIndexMergeRateLimiter_PauseResult, NO));
    }
    if (curPauseNS > 250LL * 1000000) {
      curPauseNS = 250LL * 1000000;
    }
    jint sleepMS = (jint) (JreLongDiv(curPauseNS, 1000000));
    jint sleepNS = (jint) (JreLongMod(curPauseNS, 1000000));
    jdouble rate = self->mbPerSec_;
    @try {
      [self java_waitWithLong:sleepMS withInt:sleepNS];
    }
    @catch (JavaLangInterruptedException *ie) {
      @throw create_OrgApacheLuceneUtilThreadInterruptedException_initWithJavaLangInterruptedException_(ie);
    }
    if (rate == 0.0) {
      return JreRetainedLocalValue(JreLoadEnum(OrgApacheLuceneIndexMergeRateLimiter_PauseResult, STOPPED));
    }
    else {
      return JreRetainedLocalValue(JreLoadEnum(OrgApacheLuceneIndexMergeRateLimiter_PauseResult, PAUSED));
    }
  }
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(OrgApacheLuceneIndexMergeRateLimiter)

J2OBJC_INITIALIZED_DEFN(OrgApacheLuceneIndexMergeRateLimiter_PauseResult)

OrgApacheLuceneIndexMergeRateLimiter_PauseResult *OrgApacheLuceneIndexMergeRateLimiter_PauseResult_values_[3];

@implementation OrgApacheLuceneIndexMergeRateLimiter_PauseResult

+ (OrgApacheLuceneIndexMergeRateLimiter_PauseResult *)NO_ {
  return JreEnum(OrgApacheLuceneIndexMergeRateLimiter_PauseResult, NO);
}

+ (OrgApacheLuceneIndexMergeRateLimiter_PauseResult *)STOPPED {
  return JreEnum(OrgApacheLuceneIndexMergeRateLimiter_PauseResult, STOPPED);
}

+ (OrgApacheLuceneIndexMergeRateLimiter_PauseResult *)PAUSED {
  return JreEnum(OrgApacheLuceneIndexMergeRateLimiter_PauseResult, PAUSED);
}

+ (IOSObjectArray *)values {
  return OrgApacheLuceneIndexMergeRateLimiter_PauseResult_values();
}

+ (OrgApacheLuceneIndexMergeRateLimiter_PauseResult *)valueOfWithNSString:(NSString *)name {
  return OrgApacheLuceneIndexMergeRateLimiter_PauseResult_valueOfWithNSString_(name);
}

- (OrgApacheLuceneIndexMergeRateLimiter_PauseResult_Enum)toNSEnum {
  return (OrgApacheLuceneIndexMergeRateLimiter_PauseResult_Enum)[self ordinal];
}

+ (const J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { NULL, "[LOrgApacheLuceneIndexMergeRateLimiter_PauseResult;", 0x9, -1, -1, -1, -1, -1, -1 },
    { NULL, "LOrgApacheLuceneIndexMergeRateLimiter_PauseResult;", 0x9, 0, 1, -1, -1, -1, -1 },
  };
  #pragma clang diagnostic push
  #pragma clang diagnostic ignored "-Wobjc-multiple-method-names"
  #pragma clang diagnostic ignored "-Wundeclared-selector"
  methods[0].selector = @selector(values);
  methods[1].selector = @selector(valueOfWithNSString:);
  #pragma clang diagnostic pop
  static const J2ObjcFieldInfo fields[] = {
    { "NO", "LOrgApacheLuceneIndexMergeRateLimiter_PauseResult;", .constantValue.asLong = 0, 0x4019, -1, 2, -1, -1 },
    { "STOPPED", "LOrgApacheLuceneIndexMergeRateLimiter_PauseResult;", .constantValue.asLong = 0, 0x4019, -1, 3, -1, -1 },
    { "PAUSED", "LOrgApacheLuceneIndexMergeRateLimiter_PauseResult;", .constantValue.asLong = 0, 0x4019, -1, 4, -1, -1 },
  };
  static const void *ptrTable[] = { "valueOf", "LNSString;", &JreEnum(OrgApacheLuceneIndexMergeRateLimiter_PauseResult, NO), &JreEnum(OrgApacheLuceneIndexMergeRateLimiter_PauseResult, STOPPED), &JreEnum(OrgApacheLuceneIndexMergeRateLimiter_PauseResult, PAUSED), "LOrgApacheLuceneIndexMergeRateLimiter;", "Ljava/lang/Enum<Lorg/apache/lucene/index/MergeRateLimiter$PauseResult;>;" };
  static const J2ObjcClassInfo _OrgApacheLuceneIndexMergeRateLimiter_PauseResult = { "PauseResult", "org.apache.lucene.index", ptrTable, methods, fields, 7, 0x401a, 2, 3, 5, -1, -1, 6, -1 };
  return &_OrgApacheLuceneIndexMergeRateLimiter_PauseResult;
}

+ (void)initialize {
  if (self == [OrgApacheLuceneIndexMergeRateLimiter_PauseResult class]) {
    size_t objSize = class_getInstanceSize(self);
    size_t allocSize = 3 * objSize;
    uintptr_t ptr = (uintptr_t)calloc(allocSize, 1);
    id e;
    for (jint i = 0; i < 3; i++) {
      ((void)(OrgApacheLuceneIndexMergeRateLimiter_PauseResult_values_[i] = e = objc_constructInstance(self, (void *)ptr)), ptr += objSize);
      OrgApacheLuceneIndexMergeRateLimiter_PauseResult_initWithNSString_withInt_(e, JreEnumConstantName(OrgApacheLuceneIndexMergeRateLimiter_PauseResult_class_(), i), i);
    }
    J2OBJC_SET_INITIALIZED(OrgApacheLuceneIndexMergeRateLimiter_PauseResult)
  }
}

@end

void OrgApacheLuceneIndexMergeRateLimiter_PauseResult_initWithNSString_withInt_(OrgApacheLuceneIndexMergeRateLimiter_PauseResult *self, NSString *__name, jint __ordinal) {
  JavaLangEnum_initWithNSString_withInt_(self, __name, __ordinal);
}

IOSObjectArray *OrgApacheLuceneIndexMergeRateLimiter_PauseResult_values() {
  OrgApacheLuceneIndexMergeRateLimiter_PauseResult_initialize();
  return [IOSObjectArray arrayWithObjects:OrgApacheLuceneIndexMergeRateLimiter_PauseResult_values_ count:3 type:OrgApacheLuceneIndexMergeRateLimiter_PauseResult_class_()];
}

OrgApacheLuceneIndexMergeRateLimiter_PauseResult *OrgApacheLuceneIndexMergeRateLimiter_PauseResult_valueOfWithNSString_(NSString *name) {
  OrgApacheLuceneIndexMergeRateLimiter_PauseResult_initialize();
  for (int i = 0; i < 3; i++) {
    OrgApacheLuceneIndexMergeRateLimiter_PauseResult *e = OrgApacheLuceneIndexMergeRateLimiter_PauseResult_values_[i];
    if ([name isEqual:[e name]]) {
      return e;
    }
  }
  @throw create_JavaLangIllegalArgumentException_initWithNSString_(name);
  return nil;
}

OrgApacheLuceneIndexMergeRateLimiter_PauseResult *OrgApacheLuceneIndexMergeRateLimiter_PauseResult_fromOrdinal(NSUInteger ordinal) {
  OrgApacheLuceneIndexMergeRateLimiter_PauseResult_initialize();
  if (ordinal >= 3) {
    return nil;
  }
  return OrgApacheLuceneIndexMergeRateLimiter_PauseResult_values_[ordinal];
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(OrgApacheLuceneIndexMergeRateLimiter_PauseResult)
