//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: ./core/src/java/org/apache/lucene/index/FlushByRamOrCountsPolicy.java
//

#include "J2ObjC_source.h"
#include "org/apache/lucene/index/DocumentsWriterFlushControl.h"
#include "org/apache/lucene/index/DocumentsWriterPerThread.h"
#include "org/apache/lucene/index/DocumentsWriterPerThreadPool.h"
#include "org/apache/lucene/index/FlushByRamOrCountsPolicy.h"
#include "org/apache/lucene/index/FlushPolicy.h"
#include "org/apache/lucene/index/IndexWriterConfig.h"
#include "org/apache/lucene/index/LiveIndexWriterConfig.h"
#include "org/apache/lucene/util/InfoStream.h"

#if __has_feature(objc_arc)
#error "org/apache/lucene/index/FlushByRamOrCountsPolicy must not be compiled with ARC (-fobjc-arc)"
#endif

@implementation OrgApacheLuceneIndexFlushByRamOrCountsPolicy

- (instancetype)initPackagePrivate {
  OrgApacheLuceneIndexFlushByRamOrCountsPolicy_initPackagePrivate(self);
  return self;
}

- (void)onDeleteWithOrgApacheLuceneIndexDocumentsWriterFlushControl:(OrgApacheLuceneIndexDocumentsWriterFlushControl *)control
   withOrgApacheLuceneIndexDocumentsWriterPerThreadPool_ThreadState:(OrgApacheLuceneIndexDocumentsWriterPerThreadPool_ThreadState *)state {
  if ([self flushOnDeleteTerms]) {
    jint maxBufferedDeleteTerms = [((OrgApacheLuceneIndexLiveIndexWriterConfig *) nil_chk(indexWriterConfig_)) getMaxBufferedDeleteTerms];
    if ([((OrgApacheLuceneIndexDocumentsWriterFlushControl *) nil_chk(control)) getNumGlobalTermDeletes] >= maxBufferedDeleteTerms) {
      [control setApplyAllDeletes];
    }
  }
  if (([self flushOnRAM] && [((OrgApacheLuceneIndexDocumentsWriterFlushControl *) nil_chk(control)) getDeleteBytesUsed] > (1024 * 1024 * [((OrgApacheLuceneIndexLiveIndexWriterConfig *) nil_chk(indexWriterConfig_)) getRAMBufferSizeMB]))) {
    [((OrgApacheLuceneIndexDocumentsWriterFlushControl *) nil_chk(control)) setApplyAllDeletes];
    if ([((OrgApacheLuceneUtilInfoStream *) nil_chk(infoStream_)) isEnabledWithNSString:@"FP"]) {
      [((OrgApacheLuceneUtilInfoStream *) nil_chk(infoStream_)) messageWithNSString:@"FP" withNSString:JreStrcat("$J$D", @"force apply deletes bytesUsed=", [control getDeleteBytesUsed], @" vs ramBufferMB=", [((OrgApacheLuceneIndexLiveIndexWriterConfig *) nil_chk(indexWriterConfig_)) getRAMBufferSizeMB])];
    }
  }
}

- (void)onInsertWithOrgApacheLuceneIndexDocumentsWriterFlushControl:(OrgApacheLuceneIndexDocumentsWriterFlushControl *)control
   withOrgApacheLuceneIndexDocumentsWriterPerThreadPool_ThreadState:(OrgApacheLuceneIndexDocumentsWriterPerThreadPool_ThreadState *)state {
  if ([self flushOnDocCount] && [((OrgApacheLuceneIndexDocumentsWriterPerThread *) nil_chk(((OrgApacheLuceneIndexDocumentsWriterPerThreadPool_ThreadState *) nil_chk(state))->dwpt_)) getNumDocsInRAM] >= [((OrgApacheLuceneIndexLiveIndexWriterConfig *) nil_chk(indexWriterConfig_)) getMaxBufferedDocs]) {
    [((OrgApacheLuceneIndexDocumentsWriterFlushControl *) nil_chk(control)) setFlushPendingWithOrgApacheLuceneIndexDocumentsWriterPerThreadPool_ThreadState:state];
  }
  else if ([self flushOnRAM]) {
    jlong limit = JreFpToLong(([((OrgApacheLuceneIndexLiveIndexWriterConfig *) nil_chk(indexWriterConfig_)) getRAMBufferSizeMB] * 1024. * 1024.));
    jlong totalRam = [((OrgApacheLuceneIndexDocumentsWriterFlushControl *) nil_chk(control)) activeBytes] + [control getDeleteBytesUsed];
    if (totalRam >= limit) {
      if ([((OrgApacheLuceneUtilInfoStream *) nil_chk(infoStream_)) isEnabledWithNSString:@"FP"]) {
        [((OrgApacheLuceneUtilInfoStream *) nil_chk(infoStream_)) messageWithNSString:@"FP" withNSString:JreStrcat("$J$J$J", @"trigger flush: activeBytes=", [control activeBytes], @" deleteBytes=", [control getDeleteBytesUsed], @" vs limit=", limit)];
      }
      [self markLargestWriterPendingWithOrgApacheLuceneIndexDocumentsWriterFlushControl:control withOrgApacheLuceneIndexDocumentsWriterPerThreadPool_ThreadState:state withLong:totalRam];
    }
  }
}

- (void)markLargestWriterPendingWithOrgApacheLuceneIndexDocumentsWriterFlushControl:(OrgApacheLuceneIndexDocumentsWriterFlushControl *)control
                   withOrgApacheLuceneIndexDocumentsWriterPerThreadPool_ThreadState:(OrgApacheLuceneIndexDocumentsWriterPerThreadPool_ThreadState *)perThreadState
                                                                           withLong:(jlong)currentBytesPerThread {
  [((OrgApacheLuceneIndexDocumentsWriterFlushControl *) nil_chk(control)) setFlushPendingWithOrgApacheLuceneIndexDocumentsWriterPerThreadPool_ThreadState:[self findLargestNonPendingWriterWithOrgApacheLuceneIndexDocumentsWriterFlushControl:control withOrgApacheLuceneIndexDocumentsWriterPerThreadPool_ThreadState:perThreadState]];
}

- (jboolean)flushOnDocCount {
  return [((OrgApacheLuceneIndexLiveIndexWriterConfig *) nil_chk(indexWriterConfig_)) getMaxBufferedDocs] != OrgApacheLuceneIndexIndexWriterConfig_DISABLE_AUTO_FLUSH;
}

- (jboolean)flushOnDeleteTerms {
  return [((OrgApacheLuceneIndexLiveIndexWriterConfig *) nil_chk(indexWriterConfig_)) getMaxBufferedDeleteTerms] != OrgApacheLuceneIndexIndexWriterConfig_DISABLE_AUTO_FLUSH;
}

- (jboolean)flushOnRAM {
  return [((OrgApacheLuceneIndexLiveIndexWriterConfig *) nil_chk(indexWriterConfig_)) getRAMBufferSizeMB] != OrgApacheLuceneIndexIndexWriterConfig_DISABLE_AUTO_FLUSH;
}

+ (const J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { NULL, NULL, 0x0, -1, -1, -1, -1, -1, -1 },
    { NULL, "V", 0x1, 0, 1, -1, -1, -1, -1 },
    { NULL, "V", 0x1, 2, 1, -1, -1, -1, -1 },
    { NULL, "V", 0x4, 3, 4, -1, -1, -1, -1 },
    { NULL, "Z", 0x4, -1, -1, -1, -1, -1, -1 },
    { NULL, "Z", 0x4, -1, -1, -1, -1, -1, -1 },
    { NULL, "Z", 0x4, -1, -1, -1, -1, -1, -1 },
  };
  #pragma clang diagnostic push
  #pragma clang diagnostic ignored "-Wobjc-multiple-method-names"
  #pragma clang diagnostic ignored "-Wundeclared-selector"
  methods[0].selector = @selector(initPackagePrivate);
  methods[1].selector = @selector(onDeleteWithOrgApacheLuceneIndexDocumentsWriterFlushControl:withOrgApacheLuceneIndexDocumentsWriterPerThreadPool_ThreadState:);
  methods[2].selector = @selector(onInsertWithOrgApacheLuceneIndexDocumentsWriterFlushControl:withOrgApacheLuceneIndexDocumentsWriterPerThreadPool_ThreadState:);
  methods[3].selector = @selector(markLargestWriterPendingWithOrgApacheLuceneIndexDocumentsWriterFlushControl:withOrgApacheLuceneIndexDocumentsWriterPerThreadPool_ThreadState:withLong:);
  methods[4].selector = @selector(flushOnDocCount);
  methods[5].selector = @selector(flushOnDeleteTerms);
  methods[6].selector = @selector(flushOnRAM);
  #pragma clang diagnostic pop
  static const void *ptrTable[] = { "onDelete", "LOrgApacheLuceneIndexDocumentsWriterFlushControl;LOrgApacheLuceneIndexDocumentsWriterPerThreadPool_ThreadState;", "onInsert", "markLargestWriterPending", "LOrgApacheLuceneIndexDocumentsWriterFlushControl;LOrgApacheLuceneIndexDocumentsWriterPerThreadPool_ThreadState;J" };
  static const J2ObjcClassInfo _OrgApacheLuceneIndexFlushByRamOrCountsPolicy = { "FlushByRamOrCountsPolicy", "org.apache.lucene.index", ptrTable, methods, NULL, 7, 0x0, 7, 0, -1, -1, -1, -1, -1 };
  return &_OrgApacheLuceneIndexFlushByRamOrCountsPolicy;
}

@end

void OrgApacheLuceneIndexFlushByRamOrCountsPolicy_initPackagePrivate(OrgApacheLuceneIndexFlushByRamOrCountsPolicy *self) {
  OrgApacheLuceneIndexFlushPolicy_initPackagePrivate(self);
}

OrgApacheLuceneIndexFlushByRamOrCountsPolicy *new_OrgApacheLuceneIndexFlushByRamOrCountsPolicy_initPackagePrivate() {
  J2OBJC_NEW_IMPL(OrgApacheLuceneIndexFlushByRamOrCountsPolicy, initPackagePrivate)
}

OrgApacheLuceneIndexFlushByRamOrCountsPolicy *create_OrgApacheLuceneIndexFlushByRamOrCountsPolicy_initPackagePrivate() {
  J2OBJC_CREATE_IMPL(OrgApacheLuceneIndexFlushByRamOrCountsPolicy, initPackagePrivate)
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(OrgApacheLuceneIndexFlushByRamOrCountsPolicy)
