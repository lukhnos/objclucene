//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: ./core/src/java/org/apache/lucene/index/FreqProxTermsWriter.java
//

#include "IOSClass.h"
#include "IOSObjectArray.h"
#include "IOSPrimitiveArray.h"
#include "J2ObjC_source.h"
#include "java/io/Closeable.h"
#include "java/lang/Integer.h"
#include "java/util/ArrayList.h"
#include "java/util/Collection.h"
#include "java/util/Collections.h"
#include "java/util/List.h"
#include "java/util/Map.h"
#include "java/util/Set.h"
#include "org/apache/lucene/codecs/Codec.h"
#include "org/apache/lucene/codecs/FieldsConsumer.h"
#include "org/apache/lucene/codecs/LiveDocsFormat.h"
#include "org/apache/lucene/codecs/PostingsFormat.h"
#include "org/apache/lucene/index/BufferedUpdates.h"
#include "org/apache/lucene/index/DocumentsWriterPerThread.h"
#include "org/apache/lucene/index/FieldInfo.h"
#include "org/apache/lucene/index/FieldInvertState.h"
#include "org/apache/lucene/index/Fields.h"
#include "org/apache/lucene/index/FreqProxFields.h"
#include "org/apache/lucene/index/FreqProxTermsWriter.h"
#include "org/apache/lucene/index/FreqProxTermsWriterPerField.h"
#include "org/apache/lucene/index/IndexOptions.h"
#include "org/apache/lucene/index/PostingsEnum.h"
#include "org/apache/lucene/index/SegmentInfo.h"
#include "org/apache/lucene/index/SegmentWriteState.h"
#include "org/apache/lucene/index/Term.h"
#include "org/apache/lucene/index/Terms.h"
#include "org/apache/lucene/index/TermsEnum.h"
#include "org/apache/lucene/index/TermsHash.h"
#include "org/apache/lucene/index/TermsHashPerField.h"
#include "org/apache/lucene/search/DocIdSetIterator.h"
#include "org/apache/lucene/util/BytesRef.h"
#include "org/apache/lucene/util/BytesRefHash.h"
#include "org/apache/lucene/util/CollectionUtil.h"
#include "org/apache/lucene/util/IOUtils.h"
#include "org/apache/lucene/util/MutableBits.h"

#if __has_feature(objc_arc)
#error "org/apache/lucene/index/FreqProxTermsWriter must not be compiled with ARC (-fobjc-arc)"
#endif

@interface OrgApacheLuceneIndexFreqProxTermsWriter ()

- (void)applyDeletesWithOrgApacheLuceneIndexSegmentWriteState:(OrgApacheLuceneIndexSegmentWriteState *)state
                               withOrgApacheLuceneIndexFields:(OrgApacheLuceneIndexFields *)fields;

@end

__attribute__((unused)) static void OrgApacheLuceneIndexFreqProxTermsWriter_applyDeletesWithOrgApacheLuceneIndexSegmentWriteState_withOrgApacheLuceneIndexFields_(OrgApacheLuceneIndexFreqProxTermsWriter *self, OrgApacheLuceneIndexSegmentWriteState *state, OrgApacheLuceneIndexFields *fields);

@implementation OrgApacheLuceneIndexFreqProxTermsWriter

- (instancetype)initPackagePrivateWithOrgApacheLuceneIndexDocumentsWriterPerThread:(OrgApacheLuceneIndexDocumentsWriterPerThread *)docWriter
                                                 withOrgApacheLuceneIndexTermsHash:(OrgApacheLuceneIndexTermsHash *)termVectors {
  OrgApacheLuceneIndexFreqProxTermsWriter_initPackagePrivateWithOrgApacheLuceneIndexDocumentsWriterPerThread_withOrgApacheLuceneIndexTermsHash_(self, docWriter, termVectors);
  return self;
}

- (void)applyDeletesWithOrgApacheLuceneIndexSegmentWriteState:(OrgApacheLuceneIndexSegmentWriteState *)state
                               withOrgApacheLuceneIndexFields:(OrgApacheLuceneIndexFields *)fields {
  OrgApacheLuceneIndexFreqProxTermsWriter_applyDeletesWithOrgApacheLuceneIndexSegmentWriteState_withOrgApacheLuceneIndexFields_(self, state, fields);
}

- (void)flushWithJavaUtilMap:(id<JavaUtilMap>)fieldsToFlush
withOrgApacheLuceneIndexSegmentWriteState:(OrgApacheLuceneIndexSegmentWriteState *)state {
  [super flushWithJavaUtilMap:fieldsToFlush withOrgApacheLuceneIndexSegmentWriteState:state];
  id<JavaUtilList> allFields = create_JavaUtilArrayList_init();
  for (OrgApacheLuceneIndexTermsHashPerField * __strong f in nil_chk([((id<JavaUtilMap>) nil_chk(fieldsToFlush)) values])) {
    OrgApacheLuceneIndexFreqProxTermsWriterPerField *perField = (OrgApacheLuceneIndexFreqProxTermsWriterPerField *) cast_chk(f, [OrgApacheLuceneIndexFreqProxTermsWriterPerField class]);
    if ([((OrgApacheLuceneUtilBytesRefHash *) nil_chk(((OrgApacheLuceneIndexFreqProxTermsWriterPerField *) nil_chk(perField))->bytesHash_)) size] > 0) {
      [perField sortPostings];
      JreAssert([((OrgApacheLuceneIndexFieldInfo *) nil_chk(perField->fieldInfo_)) getIndexOptions] != JreLoadEnum(OrgApacheLuceneIndexIndexOptions, NONE), @"org/apache/lucene/index/FreqProxTermsWriter.java:92 condition failed: assert perField.fieldInfo.getIndexOptions() != IndexOptions.NONE;");
      [allFields addWithId:perField];
    }
  }
  OrgApacheLuceneUtilCollectionUtil_introSortWithJavaUtilList_(allFields);
  OrgApacheLuceneIndexFields *fields = create_OrgApacheLuceneIndexFreqProxFields_initPackagePrivateWithJavaUtilList_(allFields);
  OrgApacheLuceneIndexFreqProxTermsWriter_applyDeletesWithOrgApacheLuceneIndexSegmentWriteState_withOrgApacheLuceneIndexFields_(self, state, fields);
  OrgApacheLuceneCodecsFieldsConsumer *consumer = JreRetainedLocalValue([((OrgApacheLuceneCodecsPostingsFormat *) nil_chk([((OrgApacheLuceneCodecsCodec *) nil_chk([((OrgApacheLuceneIndexSegmentInfo *) nil_chk(((OrgApacheLuceneIndexSegmentWriteState *) nil_chk(state))->segmentInfo_)) getCodec])) postingsFormat])) fieldsConsumerWithOrgApacheLuceneIndexSegmentWriteState:state]);
  jboolean success = false;
  @try {
    [((OrgApacheLuceneCodecsFieldsConsumer *) nil_chk(consumer)) writeWithOrgApacheLuceneIndexFields:fields];
    success = true;
  }
  @finally {
    if (success) {
      OrgApacheLuceneUtilIOUtils_closeWithJavaIoCloseableArray_([IOSObjectArray arrayWithObjects:(id[]){ consumer } count:1 type:JavaIoCloseable_class_()]);
    }
    else {
      OrgApacheLuceneUtilIOUtils_closeWhileHandlingExceptionWithJavaIoCloseableArray_([IOSObjectArray arrayWithObjects:(id[]){ consumer } count:1 type:JavaIoCloseable_class_()]);
    }
  }
}

- (OrgApacheLuceneIndexTermsHashPerField *)addFieldWithOrgApacheLuceneIndexFieldInvertState:(OrgApacheLuceneIndexFieldInvertState *)invertState
                                                          withOrgApacheLuceneIndexFieldInfo:(OrgApacheLuceneIndexFieldInfo *)fieldInfo {
  return create_OrgApacheLuceneIndexFreqProxTermsWriterPerField_initPackagePrivateWithOrgApacheLuceneIndexFieldInvertState_withOrgApacheLuceneIndexTermsHash_withOrgApacheLuceneIndexFieldInfo_withOrgApacheLuceneIndexTermsHashPerField_(invertState, self, fieldInfo, [((OrgApacheLuceneIndexTermsHash *) nil_chk(nextTermsHash_)) addFieldWithOrgApacheLuceneIndexFieldInvertState:invertState withOrgApacheLuceneIndexFieldInfo:fieldInfo]);
}

+ (const J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { NULL, NULL, 0x1, -1, 0, -1, -1, -1, -1 },
    { NULL, "V", 0x2, 1, 2, 3, -1, -1, -1 },
    { NULL, "V", 0x1, 4, 5, 3, 6, -1, -1 },
    { NULL, "LOrgApacheLuceneIndexTermsHashPerField;", 0x1, 7, 8, -1, -1, -1, -1 },
  };
  #pragma clang diagnostic push
  #pragma clang diagnostic ignored "-Wobjc-multiple-method-names"
  #pragma clang diagnostic ignored "-Wundeclared-selector"
  methods[0].selector = @selector(initPackagePrivateWithOrgApacheLuceneIndexDocumentsWriterPerThread:withOrgApacheLuceneIndexTermsHash:);
  methods[1].selector = @selector(applyDeletesWithOrgApacheLuceneIndexSegmentWriteState:withOrgApacheLuceneIndexFields:);
  methods[2].selector = @selector(flushWithJavaUtilMap:withOrgApacheLuceneIndexSegmentWriteState:);
  methods[3].selector = @selector(addFieldWithOrgApacheLuceneIndexFieldInvertState:withOrgApacheLuceneIndexFieldInfo:);
  #pragma clang diagnostic pop
  static const void *ptrTable[] = { "LOrgApacheLuceneIndexDocumentsWriterPerThread;LOrgApacheLuceneIndexTermsHash;", "applyDeletes", "LOrgApacheLuceneIndexSegmentWriteState;LOrgApacheLuceneIndexFields;", "LJavaIoIOException;", "flush", "LJavaUtilMap;LOrgApacheLuceneIndexSegmentWriteState;", "(Ljava/util/Map<Ljava/lang/String;Lorg/apache/lucene/index/TermsHashPerField;>;Lorg/apache/lucene/index/SegmentWriteState;)V", "addField", "LOrgApacheLuceneIndexFieldInvertState;LOrgApacheLuceneIndexFieldInfo;" };
  static const J2ObjcClassInfo _OrgApacheLuceneIndexFreqProxTermsWriter = { "FreqProxTermsWriter", "org.apache.lucene.index", ptrTable, methods, NULL, 7, 0x10, 4, 0, -1, -1, -1, -1, -1 };
  return &_OrgApacheLuceneIndexFreqProxTermsWriter;
}

@end

void OrgApacheLuceneIndexFreqProxTermsWriter_initPackagePrivateWithOrgApacheLuceneIndexDocumentsWriterPerThread_withOrgApacheLuceneIndexTermsHash_(OrgApacheLuceneIndexFreqProxTermsWriter *self, OrgApacheLuceneIndexDocumentsWriterPerThread *docWriter, OrgApacheLuceneIndexTermsHash *termVectors) {
  OrgApacheLuceneIndexTermsHash_initPackagePrivateWithOrgApacheLuceneIndexDocumentsWriterPerThread_withBoolean_withOrgApacheLuceneIndexTermsHash_(self, docWriter, true, termVectors);
}

OrgApacheLuceneIndexFreqProxTermsWriter *new_OrgApacheLuceneIndexFreqProxTermsWriter_initPackagePrivateWithOrgApacheLuceneIndexDocumentsWriterPerThread_withOrgApacheLuceneIndexTermsHash_(OrgApacheLuceneIndexDocumentsWriterPerThread *docWriter, OrgApacheLuceneIndexTermsHash *termVectors) {
  J2OBJC_NEW_IMPL(OrgApacheLuceneIndexFreqProxTermsWriter, initPackagePrivateWithOrgApacheLuceneIndexDocumentsWriterPerThread_withOrgApacheLuceneIndexTermsHash_, docWriter, termVectors)
}

OrgApacheLuceneIndexFreqProxTermsWriter *create_OrgApacheLuceneIndexFreqProxTermsWriter_initPackagePrivateWithOrgApacheLuceneIndexDocumentsWriterPerThread_withOrgApacheLuceneIndexTermsHash_(OrgApacheLuceneIndexDocumentsWriterPerThread *docWriter, OrgApacheLuceneIndexTermsHash *termVectors) {
  J2OBJC_CREATE_IMPL(OrgApacheLuceneIndexFreqProxTermsWriter, initPackagePrivateWithOrgApacheLuceneIndexDocumentsWriterPerThread_withOrgApacheLuceneIndexTermsHash_, docWriter, termVectors)
}

void OrgApacheLuceneIndexFreqProxTermsWriter_applyDeletesWithOrgApacheLuceneIndexSegmentWriteState_withOrgApacheLuceneIndexFields_(OrgApacheLuceneIndexFreqProxTermsWriter *self, OrgApacheLuceneIndexSegmentWriteState *state, OrgApacheLuceneIndexFields *fields) {
  if (((OrgApacheLuceneIndexSegmentWriteState *) nil_chk(state))->segUpdates_ != nil && [((id<JavaUtilMap>) nil_chk(state->segUpdates_->terms_)) size] > 0) {
    id<JavaUtilMap> segDeletes = JreRetainedLocalValue(state->segUpdates_->terms_);
    id<JavaUtilList> deleteTerms = create_JavaUtilArrayList_initWithJavaUtilCollection_([((id<JavaUtilMap>) nil_chk(segDeletes)) keySet]);
    JavaUtilCollections_sortWithJavaUtilList_(deleteTerms);
    NSString *lastField = nil;
    OrgApacheLuceneIndexTermsEnum *termsEnum = nil;
    OrgApacheLuceneIndexPostingsEnum *postingsEnum = nil;
    for (OrgApacheLuceneIndexTerm * __strong deleteTerm in deleteTerms) {
      if ([((NSString *) nil_chk([((OrgApacheLuceneIndexTerm *) nil_chk(deleteTerm)) field])) isEqual:lastField] == false) {
        lastField = [deleteTerm field];
        OrgApacheLuceneIndexTerms *terms = JreRetainedLocalValue([((OrgApacheLuceneIndexFields *) nil_chk(fields)) termsWithNSString:lastField]);
        if (terms != nil) {
          termsEnum = [terms iterator];
        }
        else {
          termsEnum = nil;
        }
      }
      if (termsEnum != nil && [termsEnum seekExactWithOrgApacheLuceneUtilBytesRef:[deleteTerm bytes]]) {
        postingsEnum = [termsEnum postingsWithOrgApacheLuceneIndexPostingsEnum:postingsEnum withInt:0];
        jint delDocLimit = [((JavaLangInteger *) nil_chk([segDeletes getWithId:deleteTerm])) intValue];
        JreAssert(delDocLimit < OrgApacheLuceneSearchDocIdSetIterator_NO_MORE_DOCS, @"org/apache/lucene/index/FreqProxTermsWriter.java:61 condition failed: assert delDocLimit < PostingsEnum.NO_MORE_DOCS;");
        while (true) {
          jint doc = [((OrgApacheLuceneIndexPostingsEnum *) nil_chk(postingsEnum)) nextDoc];
          if (doc < delDocLimit) {
            if (state->liveDocs_ == nil) {
              JreStrongAssign(&state->liveDocs_, [((OrgApacheLuceneCodecsLiveDocsFormat *) nil_chk([((OrgApacheLuceneCodecsCodec *) nil_chk([((OrgApacheLuceneIndexSegmentInfo *) nil_chk(state->segmentInfo_)) getCodec])) liveDocsFormat])) newLiveDocsWithInt:[state->segmentInfo_ maxDoc]]);
            }
            if ([((id<OrgApacheLuceneUtilMutableBits>) nil_chk(state->liveDocs_)) getWithInt:doc]) {
              state->delCountOnFlush_++;
              [((id<OrgApacheLuceneUtilMutableBits>) nil_chk(state->liveDocs_)) clearWithInt:doc];
            }
          }
          else {
            break;
          }
        }
      }
    }
  }
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(OrgApacheLuceneIndexFreqProxTermsWriter)
