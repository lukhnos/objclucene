//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: ./queryparser/src/java/org/apache/lucene/queryparser/surround/query/SrndTruncQuery.java
//

#include "J2ObjC_source.h"
#include "java/lang/StringBuilder.h"
#include "java/util/regex/Matcher.h"
#include "java/util/regex/Pattern.h"
#include "org/apache/lucene/index/IndexReader.h"
#include "org/apache/lucene/index/MultiFields.h"
#include "org/apache/lucene/index/Term.h"
#include "org/apache/lucene/index/Terms.h"
#include "org/apache/lucene/index/TermsEnum.h"
#include "org/apache/lucene/queryparser/surround/query/SimpleTerm.h"
#include "org/apache/lucene/queryparser/surround/query/SrndTruncQuery.h"
#include "org/apache/lucene/util/BytesRef.h"
#include "org/apache/lucene/util/StringHelper.h"

#if __has_feature(objc_arc)
#error "org/apache/lucene/queryparser/surround/query/SrndTruncQuery must not be compiled with ARC (-fobjc-arc)"
#endif

#pragma clang diagnostic ignored "-Wincomplete-implementation"

@interface OrgApacheLuceneQueryparserSurroundQuerySrndTruncQuery () {
 @public
  NSString *truncated_;
  jchar unlimited_;
  jchar mask_;
  NSString *prefix_;
  OrgApacheLuceneUtilBytesRef *prefixRef_;
  JavaUtilRegexPattern *pattern_;
}

@end

J2OBJC_FIELD_SETTER(OrgApacheLuceneQueryparserSurroundQuerySrndTruncQuery, truncated_, NSString *)
J2OBJC_FIELD_SETTER(OrgApacheLuceneQueryparserSurroundQuerySrndTruncQuery, prefix_, NSString *)
J2OBJC_FIELD_SETTER(OrgApacheLuceneQueryparserSurroundQuerySrndTruncQuery, prefixRef_, OrgApacheLuceneUtilBytesRef *)
J2OBJC_FIELD_SETTER(OrgApacheLuceneQueryparserSurroundQuerySrndTruncQuery, pattern_, JavaUtilRegexPattern *)

@implementation OrgApacheLuceneQueryparserSurroundQuerySrndTruncQuery

- (instancetype)initWithNSString:(NSString *)truncated
                        withChar:(jchar)unlimited
                        withChar:(jchar)mask {
  OrgApacheLuceneQueryparserSurroundQuerySrndTruncQuery_initWithNSString_withChar_withChar_(self, truncated, unlimited, mask);
  return self;
}

- (NSString *)getTruncated {
  return truncated_;
}

- (NSString *)toStringUnquoted {
  return [self getTruncated];
}

- (jboolean)matchingCharWithChar:(jchar)c {
  return (c != unlimited_) && (c != mask_);
}

- (void)appendRegExpForCharWithChar:(jchar)c
          withJavaLangStringBuilder:(JavaLangStringBuilder *)re {
  if (c == unlimited_) [((JavaLangStringBuilder *) nil_chk(re)) appendWithNSString:@".*"];
  else if (c == mask_) [((JavaLangStringBuilder *) nil_chk(re)) appendWithNSString:@"."];
  else [((JavaLangStringBuilder *) nil_chk(re)) appendWithChar:c];
}

- (void)truncatedToPrefixAndPattern {
  jint i = 0;
  while ((i < [((NSString *) nil_chk(truncated_)) java_length]) && [self matchingCharWithChar:[truncated_ charAtWithInt:i]]) {
    i++;
  }
  JreStrongAssign(&prefix_, [truncated_ java_substring:0 endIndex:i]);
  JreStrongAssignAndConsume(&prefixRef_, new_OrgApacheLuceneUtilBytesRef_initWithJavaLangCharSequence_(prefix_));
  JavaLangStringBuilder *re = create_JavaLangStringBuilder_init();
  while (i < [truncated_ java_length]) {
    [self appendRegExpForCharWithChar:[truncated_ charAtWithInt:i] withJavaLangStringBuilder:re];
    i++;
  }
  JreStrongAssign(&pattern_, JavaUtilRegexPattern_compileWithNSString_([re description]));
}

- (void)visitMatchingTermsWithOrgApacheLuceneIndexIndexReader:(OrgApacheLuceneIndexIndexReader *)reader
                                                 withNSString:(NSString *)fieldName
withOrgApacheLuceneQueryparserSurroundQuerySimpleTerm_MatchingTermVisitor:(id<OrgApacheLuceneQueryparserSurroundQuerySimpleTerm_MatchingTermVisitor>)mtv {
  jint prefixLength = [((NSString *) nil_chk(prefix_)) java_length];
  OrgApacheLuceneIndexTerms *terms = OrgApacheLuceneIndexMultiFields_getTermsWithOrgApacheLuceneIndexIndexReader_withNSString_(reader, fieldName);
  if (terms != nil) {
    JavaUtilRegexMatcher *matcher = JreRetainedLocalValue([((JavaUtilRegexPattern *) nil_chk(pattern_)) matcherWithJavaLangCharSequence:@""]);
    @try {
      OrgApacheLuceneIndexTermsEnum *termsEnum = JreRetainedLocalValue([terms iterator]);
      OrgApacheLuceneIndexTermsEnum_SeekStatus *status = JreRetainedLocalValue([((OrgApacheLuceneIndexTermsEnum *) nil_chk(termsEnum)) seekCeilWithOrgApacheLuceneUtilBytesRef:prefixRef_]);
      OrgApacheLuceneUtilBytesRef *text;
      if (status == JreLoadEnum(OrgApacheLuceneIndexTermsEnum_SeekStatus, FOUND)) {
        text = prefixRef_;
      }
      else if (status == JreLoadEnum(OrgApacheLuceneIndexTermsEnum_SeekStatus, NOT_FOUND)) {
        text = [termsEnum term];
      }
      else {
        text = nil;
      }
      while (text != nil) {
        if (text != nil && OrgApacheLuceneUtilStringHelper_startsWithWithOrgApacheLuceneUtilBytesRef_withOrgApacheLuceneUtilBytesRef_(text, prefixRef_)) {
          NSString *textString = JreRetainedLocalValue([text utf8ToString]);
          [((JavaUtilRegexMatcher *) nil_chk(matcher)) resetWithJavaLangCharSequence:[((NSString *) nil_chk(textString)) java_substring:prefixLength]];
          if ([matcher matches]) {
            [((id<OrgApacheLuceneQueryparserSurroundQuerySimpleTerm_MatchingTermVisitor>) nil_chk(mtv)) visitMatchingTermWithOrgApacheLuceneIndexTerm:create_OrgApacheLuceneIndexTerm_initWithNSString_withNSString_(fieldName, textString)];
          }
        }
        else {
          break;
        }
        text = [termsEnum next];
      }
    }
    @finally {
      [((JavaUtilRegexMatcher *) nil_chk(matcher)) reset];
    }
  }
}

- (void)dealloc {
  RELEASE_(truncated_);
  RELEASE_(prefix_);
  RELEASE_(prefixRef_);
  RELEASE_(pattern_);
  [super dealloc];
}

+ (const J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { NULL, NULL, 0x1, -1, 0, -1, -1, -1, -1 },
    { NULL, "LNSString;", 0x1, -1, -1, -1, -1, -1, -1 },
    { NULL, "LNSString;", 0x1, -1, -1, -1, -1, -1, -1 },
    { NULL, "Z", 0x4, 1, 2, -1, -1, -1, -1 },
    { NULL, "V", 0x4, 3, 4, -1, -1, -1, -1 },
    { NULL, "V", 0x4, -1, -1, -1, -1, -1, -1 },
    { NULL, "V", 0x1, 5, 6, 7, -1, -1, -1 },
  };
  #pragma clang diagnostic push
  #pragma clang diagnostic ignored "-Wobjc-multiple-method-names"
  #pragma clang diagnostic ignored "-Wundeclared-selector"
  methods[0].selector = @selector(initWithNSString:withChar:withChar:);
  methods[1].selector = @selector(getTruncated);
  methods[2].selector = @selector(toStringUnquoted);
  methods[3].selector = @selector(matchingCharWithChar:);
  methods[4].selector = @selector(appendRegExpForCharWithChar:withJavaLangStringBuilder:);
  methods[5].selector = @selector(truncatedToPrefixAndPattern);
  methods[6].selector = @selector(visitMatchingTermsWithOrgApacheLuceneIndexIndexReader:withNSString:withOrgApacheLuceneQueryparserSurroundQuerySimpleTerm_MatchingTermVisitor:);
  #pragma clang diagnostic pop
  static const J2ObjcFieldInfo fields[] = {
    { "truncated_", "LNSString;", .constantValue.asLong = 0, 0x12, -1, -1, -1, -1 },
    { "unlimited_", "C", .constantValue.asLong = 0, 0x12, -1, -1, -1, -1 },
    { "mask_", "C", .constantValue.asLong = 0, 0x12, -1, -1, -1, -1 },
    { "prefix_", "LNSString;", .constantValue.asLong = 0, 0x2, -1, -1, -1, -1 },
    { "prefixRef_", "LOrgApacheLuceneUtilBytesRef;", .constantValue.asLong = 0, 0x2, -1, -1, -1, -1 },
    { "pattern_", "LJavaUtilRegexPattern;", .constantValue.asLong = 0, 0x2, -1, -1, -1, -1 },
  };
  static const void *ptrTable[] = { "LNSString;CC", "matchingChar", "C", "appendRegExpForChar", "CLJavaLangStringBuilder;", "visitMatchingTerms", "LOrgApacheLuceneIndexIndexReader;LNSString;LOrgApacheLuceneQueryparserSurroundQuerySimpleTerm_MatchingTermVisitor;", "LJavaIoIOException;" };
  static const J2ObjcClassInfo _OrgApacheLuceneQueryparserSurroundQuerySrndTruncQuery = { "SrndTruncQuery", "org.apache.lucene.queryparser.surround.query", ptrTable, methods, fields, 7, 0x1, 7, 6, -1, -1, -1, -1, -1 };
  return &_OrgApacheLuceneQueryparserSurroundQuerySrndTruncQuery;
}

@end

void OrgApacheLuceneQueryparserSurroundQuerySrndTruncQuery_initWithNSString_withChar_withChar_(OrgApacheLuceneQueryparserSurroundQuerySrndTruncQuery *self, NSString *truncated, jchar unlimited, jchar mask) {
  OrgApacheLuceneQueryparserSurroundQuerySimpleTerm_initWithBoolean_(self, false);
  JreStrongAssign(&self->truncated_, truncated);
  self->unlimited_ = unlimited;
  self->mask_ = mask;
  [self truncatedToPrefixAndPattern];
}

OrgApacheLuceneQueryparserSurroundQuerySrndTruncQuery *new_OrgApacheLuceneQueryparserSurroundQuerySrndTruncQuery_initWithNSString_withChar_withChar_(NSString *truncated, jchar unlimited, jchar mask) {
  J2OBJC_NEW_IMPL(OrgApacheLuceneQueryparserSurroundQuerySrndTruncQuery, initWithNSString_withChar_withChar_, truncated, unlimited, mask)
}

OrgApacheLuceneQueryparserSurroundQuerySrndTruncQuery *create_OrgApacheLuceneQueryparserSurroundQuerySrndTruncQuery_initWithNSString_withChar_withChar_(NSString *truncated, jchar unlimited, jchar mask) {
  J2OBJC_CREATE_IMPL(OrgApacheLuceneQueryparserSurroundQuerySrndTruncQuery, initWithNSString_withChar_withChar_, truncated, unlimited, mask)
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(OrgApacheLuceneQueryparserSurroundQuerySrndTruncQuery)
