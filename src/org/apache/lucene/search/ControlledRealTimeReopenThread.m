//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: ./core/src/java/org/apache/lucene/search/ControlledRealTimeReopenThread.java
//

#include "J2ObjC_source.h"
#include "java/io/IOException.h"
#include "java/lang/IllegalArgumentException.h"
#include "java/lang/InterruptedException.h"
#include "java/lang/Long.h"
#include "java/lang/Math.h"
#include "java/lang/RuntimeException.h"
#include "java/lang/System.h"
#include "java/lang/Thread.h"
#include "java/util/concurrent/locks/Condition.h"
#include "java/util/concurrent/locks/ReentrantLock.h"
#include "org/apache/lucene/index/TrackingIndexWriter.h"
#include "org/apache/lucene/search/ControlledRealTimeReopenThread.h"
#include "org/apache/lucene/search/ReferenceManager.h"
#include "org/apache/lucene/util/ThreadInterruptedException.h"

#if __has_feature(objc_arc)
#error "org/apache/lucene/search/ControlledRealTimeReopenThread must not be compiled with ARC (-fobjc-arc)"
#endif

@interface OrgApacheLuceneSearchControlledRealTimeReopenThread () {
 @public
  OrgApacheLuceneSearchReferenceManager *manager_;
  jlong targetMaxStaleNS_;
  jlong targetMinStaleNS_;
  OrgApacheLuceneIndexTrackingIndexWriter *writer_;
  volatile_jboolean finish_;
  volatile_jlong waitingGen_;
  volatile_jlong searchingGen_;
  jlong refreshStartGen_;
  JavaUtilConcurrentLocksReentrantLock *reopenLock_;
  id<JavaUtilConcurrentLocksCondition> reopenCond_;
}

- (void)refreshDone;

@end

J2OBJC_FIELD_SETTER(OrgApacheLuceneSearchControlledRealTimeReopenThread, manager_, OrgApacheLuceneSearchReferenceManager *)
J2OBJC_FIELD_SETTER(OrgApacheLuceneSearchControlledRealTimeReopenThread, writer_, OrgApacheLuceneIndexTrackingIndexWriter *)
J2OBJC_FIELD_SETTER(OrgApacheLuceneSearchControlledRealTimeReopenThread, reopenLock_, JavaUtilConcurrentLocksReentrantLock *)
J2OBJC_FIELD_SETTER(OrgApacheLuceneSearchControlledRealTimeReopenThread, reopenCond_, id<JavaUtilConcurrentLocksCondition>)

__attribute__((unused)) static void OrgApacheLuceneSearchControlledRealTimeReopenThread_refreshDone(OrgApacheLuceneSearchControlledRealTimeReopenThread *self);

@interface OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh : NSObject < OrgApacheLuceneSearchReferenceManager_RefreshListener > {
 @public
  OrgApacheLuceneSearchControlledRealTimeReopenThread *this$0_;
}

- (instancetype)initWithOrgApacheLuceneSearchControlledRealTimeReopenThread:(OrgApacheLuceneSearchControlledRealTimeReopenThread *)outer$;

- (void)beforeRefresh;

- (void)afterRefreshWithBoolean:(jboolean)didRefresh;

@end

J2OBJC_EMPTY_STATIC_INIT(OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh)

__attribute__((unused)) static void OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh_initWithOrgApacheLuceneSearchControlledRealTimeReopenThread_(OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh *self, OrgApacheLuceneSearchControlledRealTimeReopenThread *outer$);

__attribute__((unused)) static OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh *new_OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh_initWithOrgApacheLuceneSearchControlledRealTimeReopenThread_(OrgApacheLuceneSearchControlledRealTimeReopenThread *outer$) NS_RETURNS_RETAINED;

__attribute__((unused)) static OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh *create_OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh_initWithOrgApacheLuceneSearchControlledRealTimeReopenThread_(OrgApacheLuceneSearchControlledRealTimeReopenThread *outer$);

J2OBJC_TYPE_LITERAL_HEADER(OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh)

@implementation OrgApacheLuceneSearchControlledRealTimeReopenThread

- (instancetype)initWithOrgApacheLuceneIndexTrackingIndexWriter:(OrgApacheLuceneIndexTrackingIndexWriter *)writer
                      withOrgApacheLuceneSearchReferenceManager:(OrgApacheLuceneSearchReferenceManager *)manager
                                                     withDouble:(jdouble)targetMaxStaleSec
                                                     withDouble:(jdouble)targetMinStaleSec {
  OrgApacheLuceneSearchControlledRealTimeReopenThread_initWithOrgApacheLuceneIndexTrackingIndexWriter_withOrgApacheLuceneSearchReferenceManager_withDouble_withDouble_(self, writer, manager, targetMaxStaleSec, targetMinStaleSec);
  return self;
}

- (void)refreshDone {
  OrgApacheLuceneSearchControlledRealTimeReopenThread_refreshDone(self);
}

- (void)close {
  @synchronized(self) {
    JreAssignVolatileBoolean(&finish_, true);
    [((JavaUtilConcurrentLocksReentrantLock *) nil_chk(reopenLock_)) lock];
    @try {
      [((id<JavaUtilConcurrentLocksCondition>) nil_chk(reopenCond_)) signal];
    }
    @finally {
      [reopenLock_ unlock];
    }
    @try {
      [self join];
    }
    @catch (JavaLangInterruptedException *ie) {
      @throw create_OrgApacheLuceneUtilThreadInterruptedException_initWithJavaLangInterruptedException_(ie);
    }
    JreAssignVolatileLong(&searchingGen_, JavaLangLong_MAX_VALUE);
    [self java_notifyAll];
  }
}

- (void)waitForGenerationWithLong:(jlong)targetGen {
  [self waitForGenerationWithLong:targetGen withInt:-1];
}

- (jboolean)waitForGenerationWithLong:(jlong)targetGen
                              withInt:(jint)maxMS {
  @synchronized(self) {
    jlong curGen = [((OrgApacheLuceneIndexTrackingIndexWriter *) nil_chk(writer_)) getGeneration];
    if (targetGen > curGen) {
      @throw create_JavaLangIllegalArgumentException_initWithNSString_(JreStrcat("$J$JC", @"targetGen=", targetGen, @" was never returned by the ReferenceManager instance (current gen=", curGen, ')'));
    }
    if (targetGen > JreLoadVolatileLong(&searchingGen_)) {
      [((JavaUtilConcurrentLocksReentrantLock *) nil_chk(reopenLock_)) lock];
      JreAssignVolatileLong(&waitingGen_, JavaLangMath_maxWithLong_withLong_(JreLoadVolatileLong(&waitingGen_), targetGen));
      @try {
        [((id<JavaUtilConcurrentLocksCondition>) nil_chk(reopenCond_)) signal];
      }
      @finally {
        [reopenLock_ unlock];
      }
      jlong startMS = JreLongDiv(JavaLangSystem_nanoTime(), 1000000);
      while (targetGen > JreLoadVolatileLong(&searchingGen_)) {
        if (maxMS < 0) {
          [self java_wait];
        }
        else {
          jlong msLeft = (startMS + maxMS) - JreLongDiv((JavaLangSystem_nanoTime()), 1000000);
          if (msLeft <= 0) {
            return false;
          }
          else {
            [self java_waitWithLong:msLeft];
          }
        }
      }
    }
    return true;
  }
}

- (void)run {
  jlong lastReopenStartNS = JavaLangSystem_nanoTime();
  while (!JreLoadVolatileBoolean(&finish_)) {
    while (!JreLoadVolatileBoolean(&finish_)) {
      [((JavaUtilConcurrentLocksReentrantLock *) nil_chk(reopenLock_)) lock];
      @try {
        jboolean hasWaiting = JreLoadVolatileLong(&waitingGen_) > JreLoadVolatileLong(&searchingGen_);
        jlong nextReopenStartNS = lastReopenStartNS + (hasWaiting ? targetMinStaleNS_ : targetMaxStaleNS_);
        jlong sleepNS = nextReopenStartNS - JavaLangSystem_nanoTime();
        if (sleepNS > 0) {
          [((id<JavaUtilConcurrentLocksCondition>) nil_chk(reopenCond_)) awaitNanosWithLong:sleepNS];
        }
        else {
          break;
        }
      }
      @catch (JavaLangInterruptedException *ie) {
        [((JavaLangThread *) nil_chk(JavaLangThread_currentThread())) interrupt];
        return;
      }
      @finally {
        [reopenLock_ unlock];
      }
    }
    if (JreLoadVolatileBoolean(&finish_)) {
      break;
    }
    lastReopenStartNS = JavaLangSystem_nanoTime();
    refreshStartGen_ = [((OrgApacheLuceneIndexTrackingIndexWriter *) nil_chk(writer_)) getAndIncrementGeneration];
    @try {
      [((OrgApacheLuceneSearchReferenceManager *) nil_chk(manager_)) maybeRefreshBlocking];
    }
    @catch (JavaIoIOException *ioe) {
      @throw create_JavaLangRuntimeException_initWithJavaLangThrowable_(ioe);
    }
  }
}

- (void)dealloc {
  RELEASE_(manager_);
  RELEASE_(writer_);
  RELEASE_(reopenLock_);
  RELEASE_(reopenCond_);
  [super dealloc];
}

+ (const J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { NULL, NULL, 0x1, -1, 0, -1, 1, -1, -1 },
    { NULL, "V", 0x22, -1, -1, -1, -1, -1, -1 },
    { NULL, "V", 0x21, -1, -1, -1, -1, -1, -1 },
    { NULL, "V", 0x1, 2, 3, 4, -1, -1, -1 },
    { NULL, "Z", 0x21, 2, 5, 4, -1, -1, -1 },
    { NULL, "V", 0x1, -1, -1, -1, -1, -1, -1 },
  };
  #pragma clang diagnostic push
  #pragma clang diagnostic ignored "-Wobjc-multiple-method-names"
  #pragma clang diagnostic ignored "-Wundeclared-selector"
  methods[0].selector = @selector(initWithOrgApacheLuceneIndexTrackingIndexWriter:withOrgApacheLuceneSearchReferenceManager:withDouble:withDouble:);
  methods[1].selector = @selector(refreshDone);
  methods[2].selector = @selector(close);
  methods[3].selector = @selector(waitForGenerationWithLong:);
  methods[4].selector = @selector(waitForGenerationWithLong:withInt:);
  methods[5].selector = @selector(run);
  #pragma clang diagnostic pop
  static const J2ObjcFieldInfo fields[] = {
    { "manager_", "LOrgApacheLuceneSearchReferenceManager;", .constantValue.asLong = 0, 0x12, -1, -1, 6, -1 },
    { "targetMaxStaleNS_", "J", .constantValue.asLong = 0, 0x12, -1, -1, -1, -1 },
    { "targetMinStaleNS_", "J", .constantValue.asLong = 0, 0x12, -1, -1, -1, -1 },
    { "writer_", "LOrgApacheLuceneIndexTrackingIndexWriter;", .constantValue.asLong = 0, 0x12, -1, -1, -1, -1 },
    { "finish_", "Z", .constantValue.asLong = 0, 0x42, -1, -1, -1, -1 },
    { "waitingGen_", "J", .constantValue.asLong = 0, 0x42, -1, -1, -1, -1 },
    { "searchingGen_", "J", .constantValue.asLong = 0, 0x42, -1, -1, -1, -1 },
    { "refreshStartGen_", "J", .constantValue.asLong = 0, 0x2, -1, -1, -1, -1 },
    { "reopenLock_", "LJavaUtilConcurrentLocksReentrantLock;", .constantValue.asLong = 0, 0x12, -1, -1, -1, -1 },
    { "reopenCond_", "LJavaUtilConcurrentLocksCondition;", .constantValue.asLong = 0, 0x12, -1, -1, -1, -1 },
  };
  static const void *ptrTable[] = { "LOrgApacheLuceneIndexTrackingIndexWriter;LOrgApacheLuceneSearchReferenceManager;DD", "(Lorg/apache/lucene/index/TrackingIndexWriter;Lorg/apache/lucene/search/ReferenceManager<TT;>;DD)V", "waitForGeneration", "J", "LJavaLangInterruptedException;", "JI", "Lorg/apache/lucene/search/ReferenceManager<TT;>;", "LOrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh;", "<T:Ljava/lang/Object;>Ljava/lang/Thread;Ljava/io/Closeable;" };
  static const J2ObjcClassInfo _OrgApacheLuceneSearchControlledRealTimeReopenThread = { "ControlledRealTimeReopenThread", "org.apache.lucene.search", ptrTable, methods, fields, 7, 0x1, 6, 10, -1, 7, -1, 8, -1 };
  return &_OrgApacheLuceneSearchControlledRealTimeReopenThread;
}

@end

void OrgApacheLuceneSearchControlledRealTimeReopenThread_initWithOrgApacheLuceneIndexTrackingIndexWriter_withOrgApacheLuceneSearchReferenceManager_withDouble_withDouble_(OrgApacheLuceneSearchControlledRealTimeReopenThread *self, OrgApacheLuceneIndexTrackingIndexWriter *writer, OrgApacheLuceneSearchReferenceManager *manager, jdouble targetMaxStaleSec, jdouble targetMinStaleSec) {
  JavaLangThread_init(self);
  JreStrongAssignAndConsume(&self->reopenLock_, new_JavaUtilConcurrentLocksReentrantLock_init());
  JreStrongAssign(&self->reopenCond_, [self->reopenLock_ newCondition]);
  if (targetMaxStaleSec < targetMinStaleSec) {
    @throw create_JavaLangIllegalArgumentException_initWithNSString_(JreStrcat("$D$DC", @"targetMaxScaleSec (= ", targetMaxStaleSec, @") < targetMinStaleSec (=", targetMinStaleSec, ')'));
  }
  JreStrongAssign(&self->writer_, writer);
  JreStrongAssign(&self->manager_, manager);
  self->targetMaxStaleNS_ = JreFpToLong((1000000000 * targetMaxStaleSec));
  self->targetMinStaleNS_ = JreFpToLong((1000000000 * targetMinStaleSec));
  [((OrgApacheLuceneSearchReferenceManager *) nil_chk(manager)) addListenerWithOrgApacheLuceneSearchReferenceManager_RefreshListener:create_OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh_initWithOrgApacheLuceneSearchControlledRealTimeReopenThread_(self)];
}

OrgApacheLuceneSearchControlledRealTimeReopenThread *new_OrgApacheLuceneSearchControlledRealTimeReopenThread_initWithOrgApacheLuceneIndexTrackingIndexWriter_withOrgApacheLuceneSearchReferenceManager_withDouble_withDouble_(OrgApacheLuceneIndexTrackingIndexWriter *writer, OrgApacheLuceneSearchReferenceManager *manager, jdouble targetMaxStaleSec, jdouble targetMinStaleSec) {
  J2OBJC_NEW_IMPL(OrgApacheLuceneSearchControlledRealTimeReopenThread, initWithOrgApacheLuceneIndexTrackingIndexWriter_withOrgApacheLuceneSearchReferenceManager_withDouble_withDouble_, writer, manager, targetMaxStaleSec, targetMinStaleSec)
}

OrgApacheLuceneSearchControlledRealTimeReopenThread *create_OrgApacheLuceneSearchControlledRealTimeReopenThread_initWithOrgApacheLuceneIndexTrackingIndexWriter_withOrgApacheLuceneSearchReferenceManager_withDouble_withDouble_(OrgApacheLuceneIndexTrackingIndexWriter *writer, OrgApacheLuceneSearchReferenceManager *manager, jdouble targetMaxStaleSec, jdouble targetMinStaleSec) {
  J2OBJC_CREATE_IMPL(OrgApacheLuceneSearchControlledRealTimeReopenThread, initWithOrgApacheLuceneIndexTrackingIndexWriter_withOrgApacheLuceneSearchReferenceManager_withDouble_withDouble_, writer, manager, targetMaxStaleSec, targetMinStaleSec)
}

void OrgApacheLuceneSearchControlledRealTimeReopenThread_refreshDone(OrgApacheLuceneSearchControlledRealTimeReopenThread *self) {
  @synchronized(self) {
    JreAssignVolatileLong(&self->searchingGen_, self->refreshStartGen_);
    [self java_notifyAll];
  }
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(OrgApacheLuceneSearchControlledRealTimeReopenThread)

@implementation OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh

- (instancetype)initWithOrgApacheLuceneSearchControlledRealTimeReopenThread:(OrgApacheLuceneSearchControlledRealTimeReopenThread *)outer$ {
  OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh_initWithOrgApacheLuceneSearchControlledRealTimeReopenThread_(self, outer$);
  return self;
}

- (void)beforeRefresh {
}

- (void)afterRefreshWithBoolean:(jboolean)didRefresh {
  OrgApacheLuceneSearchControlledRealTimeReopenThread_refreshDone(this$0_);
}

- (void)dealloc {
  RELEASE_(this$0_);
  [super dealloc];
}

+ (const J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { NULL, NULL, 0x2, -1, 0, -1, -1, -1, -1 },
    { NULL, "V", 0x1, -1, -1, -1, -1, -1, -1 },
    { NULL, "V", 0x1, 1, 2, -1, -1, -1, -1 },
  };
  #pragma clang diagnostic push
  #pragma clang diagnostic ignored "-Wobjc-multiple-method-names"
  #pragma clang diagnostic ignored "-Wundeclared-selector"
  methods[0].selector = @selector(initWithOrgApacheLuceneSearchControlledRealTimeReopenThread:);
  methods[1].selector = @selector(beforeRefresh);
  methods[2].selector = @selector(afterRefreshWithBoolean:);
  #pragma clang diagnostic pop
  static const J2ObjcFieldInfo fields[] = {
    { "this$0_", "LOrgApacheLuceneSearchControlledRealTimeReopenThread;", .constantValue.asLong = 0, 0x1012, -1, -1, 3, -1 },
  };
  static const void *ptrTable[] = { "LOrgApacheLuceneSearchControlledRealTimeReopenThread;", "afterRefresh", "Z", "Lorg/apache/lucene/search/ControlledRealTimeReopenThread<TT;>;" };
  static const J2ObjcClassInfo _OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh = { "HandleRefresh", "org.apache.lucene.search", ptrTable, methods, fields, 7, 0x2, 3, 1, 0, -1, -1, -1, -1 };
  return &_OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh;
}

@end

void OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh_initWithOrgApacheLuceneSearchControlledRealTimeReopenThread_(OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh *self, OrgApacheLuceneSearchControlledRealTimeReopenThread *outer$) {
  JreStrongAssign(&self->this$0_, outer$);
  NSObject_init(self);
}

OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh *new_OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh_initWithOrgApacheLuceneSearchControlledRealTimeReopenThread_(OrgApacheLuceneSearchControlledRealTimeReopenThread *outer$) {
  J2OBJC_NEW_IMPL(OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh, initWithOrgApacheLuceneSearchControlledRealTimeReopenThread_, outer$)
}

OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh *create_OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh_initWithOrgApacheLuceneSearchControlledRealTimeReopenThread_(OrgApacheLuceneSearchControlledRealTimeReopenThread *outer$) {
  J2OBJC_CREATE_IMPL(OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh, initWithOrgApacheLuceneSearchControlledRealTimeReopenThread_, outer$)
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(OrgApacheLuceneSearchControlledRealTimeReopenThread_HandleRefresh)
